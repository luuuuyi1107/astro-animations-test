
---
import { ZodiacnimalMap } from "@/libs/constants";
type Props = {
  ballLength?: number;
};

const { ballLength = 6 } = Astro.props as Props;
---

<div class="lottery-balls-container">  
  <div class="flex items-center space-x-1">
    {
      Array.from({ length: ballLength }, () => (
        <div class="ball">
          <div class="num" />
          <div class="text" />
        </div>
      ))
    }
    <div class="ball-separator">+</div>
    
    <div class="ball">
      <div class="num" />
      <div class="text" />
    </div>
  </div>
  
</div>

<script define:vars={{ballLength, ZodiacnimalMap}}>

  function init () {
    const balls = Array.from(document.querySelectorAll('.ball'));
    
     // 监听 API 资料更新事件
    document.addEventListener('api-data-updated', function(data) {
      stopAnimation()
      if (data.detail.data.OpenLottery.LastKai.KaiText) {
        
        const ballNums = data.detail.data.OpenLottery.LastKai.KaiText.split(",")
        balls.forEach((ball, index) => {
          updateBall(ball, ballNums[index]);
        });
      } else {
        startAnimation()
      }
    });

    let animationInterval = null;
    let isAnimating = false;
    // 生成随机数字 (1-49 用于普通球, 1-8 用于特别球)
    function getRandomNumber(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function getColorByNumber(num) {
      const _num = num % 3
      return _num === 0 ? "red" : _num === 1 ? "green" : "blue"
    }

    // 更新单一球的显示
    function updateBall(ballElement, num) {
      const _num = num || getRandomNumber(1, 49).toString().padStart(1, '0')

      const color = getColorByNumber(_num)
      // 添加转换效果
      if (ballElement.textContent === _num + "") return
      ballElement.setAttribute("class", `ball ${color}`);
      // ballElement.textContent = _num;
      ballElement.getElementsByClassName('num')[0].textContent = _num;
      ballElement.getElementsByClassName('text')[0].textContent = ZodiacnimalMap[_num % 12] || "22";
    }
    
    // 更新所有球
    function updateAllBalls() {
      balls.forEach((el) => updateBall(el));
    }
    
    // 开始动画
    function startAnimation() {
      if (isAnimating) return;
      isAnimating = true;
      updateAllBalls();
      animationInterval = setInterval(updateAllBalls, 500);
    }
    
    // 停止动画
    function stopAnimation() {
      if (!isAnimating) return;
      clearInterval(animationInterval);
      isAnimating = false;
    }
    startAnimation()
    // 当页面不可见时暂停动画 (节省资源)
    document.addEventListener('visibilitychange', function() {
      if (document.hidden && isAnimating) {
        clearInterval(animationInterval);
      } else if (!document.hidden && isAnimating) {
        updateAllBalls()
        animationInterval = setInterval(updateAllBalls, 500);
      }
    });
  }

  

  document.addEventListener('DOMContentLoaded', init);
  document.addEventListener('astro:page-load', init);
</script>

<style>
.lottery-balls-container .ball {
  .num {
    @apply w-5 h-5 rounded-full text-white text-center leading-5 text-xs bg-red-600;
  }

  &.blue .num {
    @apply bg-blue-600;
  }
  &.green .num {
    @apply bg-green-600;
  }
  &.red .num {
    @apply bg-red-600;
  }

  .text {
    @apply text-center min-h-5;
  }
}


</style>